<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shloka Quiz - Level 2</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e65100 0%, #ff8f00 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      padding: 30px;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .score-bar {
      background: white;
      border-radius: 15px;
      padding: 15px 25px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .score-item {
      text-align: center;
    }

    .score-item .label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }

    .score-item .value {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e65100, #ff8f00);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .question-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .question-number {
      background: linear-gradient(135deg, #e65100, #ff8f00);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
    }

    .difficulty-badge {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 500;
    }

    .difficulty-simple { background: #e8f5e9; color: #2e7d32; }
    .difficulty-intermediate { background: #fff3e0; color: #f57c00; }
    .difficulty-difficult { background: #fce4ec; color: #c2185b; }

    .question-text {
      font-size: 1.3em;
      color: #333;
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .options {
      display: grid;
      gap: 12px;
    }

    .option {
      padding: 18px 25px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1.1em;
      display: flex;
      align-items: center;
    }

    .option:hover { border-color: #e65100; background: #fff8f0; }
    .option.selected { border-color: #e65100; background: #fff3e0; }
    .option.correct { border-color: #4caf50; background: #e8f5e9; }
    .option.incorrect { border-color: #f44336; background: #ffebee; }
    .option.show-correct { border-color: #4caf50; background: #e8f5e9; }

    .option-letter {
      width: 35px; height: 35px; border-radius: 50%; background: #f0f0f0;
      display: flex; align-items: center; justify-content: center;
      margin-right: 15px; font-weight: bold; color: #666;
      flex-shrink: 0;
    }

    .option.selected .option-letter { background: #e65100; color: white; }
    .option.correct .option-letter { background: #4caf50; color: white; }
    .option.incorrect .option-letter { background: #f44336; color: white; }

    .feedback {
      margin-top: 20px; padding: 15px; border-radius: 10px;
      text-align: center; font-weight: 500; animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .feedback.correct { background: #e8f5e9; color: #2e7d32; }
    .feedback.incorrect { background: #ffebee; color: #c62828; }

    .btn {
      padding: 15px 40px; border: none; border-radius: 25px;
      font-size: 1.1em; font-weight: 600; cursor: pointer;
      transition: all 0.2s ease; margin-top: 20px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #e65100, #ff8f00); color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(230, 81, 0, 0.4);
    }

    .btn-secondary { background: #f5f5f5; color: #333; }
    .btn-center { display: block; margin: 20px auto; }

    .results { text-align: center; padding: 40px; }
    .results h2 { font-size: 2em; margin-bottom: 20px; color: #333; }

    .results .score-circle {
      width: 150px; height: 150px; border-radius: 50%;
      background: linear-gradient(135deg, #e65100, #ff8f00);
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; margin: 30px auto; color: white;
    }

    .results .score-circle .percentage { font-size: 2.5em; font-weight: bold; }
    .results .score-circle .label { font-size: 0.9em; opacity: 0.9; }
    .results .message { font-size: 1.3em; color: #666; margin-bottom: 30px; }
    .results .stats { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; }
    .results .stat { text-align: center; }
    .results .stat .value { font-size: 2em; font-weight: bold; color: #333; }
    .results .stat .label { color: #666; }

    .hidden { display: none !important; }

    .start-screen { text-align: center; padding: 40px; }
    .start-screen h2 { font-size: 1.8em; margin-bottom: 15px; color: #333; }
    .start-screen p { color: #666; margin-bottom: 30px; font-size: 1.1em; }

    .difficulty-select {
      display: flex; gap: 15px; justify-content: center;
      margin-bottom: 30px; flex-wrap: wrap;
    }

    .difficulty-btn {
      padding: 15px 30px; border: 2px solid #e0e0e0; border-radius: 10px;
      cursor: pointer; transition: all 0.2s ease; background: white;
    }

    .difficulty-btn:hover { border-color: #e65100; }
    .difficulty-btn.active { border-color: #e65100; background: #fff3e0; }
    .difficulty-btn .emoji { font-size: 2em; margin-bottom: 8px; }
    .difficulty-btn .text { font-weight: 600; color: #333; }

    /* Matching question styles */
    .matching-container {
      display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;
    }

    .matching-column {
      display: flex; flex-direction: column; gap: 10px; flex: 1; min-width: 180px;
    }

    .matching-column-header {
      font-weight: 600; color: #e65100; text-align: center;
      padding: 8px; border-bottom: 2px solid #e65100; margin-bottom: 5px;
    }

    .matching-item {
      padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px;
      cursor: pointer; transition: all 0.2s ease; text-align: center;
      font-size: 0.95em; user-select: none;
    }

    .matching-item:hover { border-color: #e65100; background: #fff8f0; }
    .matching-item.selected { border-color: #e65100; background: #fff3e0; box-shadow: 0 0 0 3px rgba(230,81,0,0.3); }
    .matching-item.matched { border-color: #4caf50; background: #e8f5e9; cursor: default; opacity: 0.85; }
    .matching-item.wrong { animation: shake 0.5s ease; border-color: #f44336; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }

    .level-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85em;
      margin-bottom: 8px;
    }

    /* Audio question styles */
    .audio-container { text-align: center; padding: 10px; }

    .sanskrit-display {
      font-size: 1.15em; line-height: 1.8; padding: 20px;
      background: #fff8f0; border-radius: 12px; margin-bottom: 20px;
      font-style: italic; color: #4a4a4a;
    }

    .sanskrit-display .blank {
      display: inline-block; min-width: 100px; border-bottom: 3px solid #e65100;
      margin: 0 4px; color: #e65100; font-weight: bold;
    }

    .record-btn {
      width: 80px; height: 80px; border-radius: 50%; border: none;
      background: #f44336; color: white; font-size: 1.5em;
      cursor: pointer; transition: all 0.2s ease; margin: 15px;
    }

    .record-btn:hover { transform: scale(1.1); }
    .record-btn.recording { animation: pulse-record 1.5s infinite; background: #d32f2f; }

    @keyframes pulse-record {
      0%, 100% { box-shadow: 0 0 0 0 rgba(244,67,54,0.7); }
      50% { box-shadow: 0 0 0 15px rgba(244,67,54,0); }
    }

    .playback-btn {
      width: 60px; height: 60px; border-radius: 50%; border: none;
      background: #e65100; color: white; font-size: 1.3em;
      cursor: pointer; margin: 15px;
    }

    .audio-controls { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 15px 0; }
    .audio-status { font-size: 0.9em; color: #666; margin: 10px 0; }

    .correct-answer-reveal {
      background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px;
      padding: 15px; margin: 15px 0; text-align: left;
    }

    .correct-answer-reveal .reveal-label { font-weight: 600; color: #2e7d32; margin-bottom: 8px; }
    .correct-answer-reveal .sanskrit { font-style: italic; color: #333; line-height: 1.6; }

    .self-assess { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }

    .self-assess-btn {
      padding: 12px 30px; border: 2px solid #e0e0e0; border-radius: 10px;
      cursor: pointer; font-size: 1em; font-weight: 600;
      transition: all 0.2s ease; background: white;
    }

    .self-assess-btn.correct-btn:hover { border-color: #4caf50; background: #e8f5e9; }
    .self-assess-btn.incorrect-btn:hover { border-color: #f44336; background: #ffebee; }

    /* Flashcard styles */
    .flashcard-controls {
      display: flex; justify-content: space-between; align-items: center;
      background: white; border-radius: 15px; padding: 12px 20px;
      margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .flashcard-counter { font-weight: 600; color: #333; font-size: 1.1em; }

    .flashcard-wrapper { perspective: 1000px; margin-bottom: 20px; }

    .flashcard {
      width: 100%; min-height: 350px; position: relative; cursor: pointer;
      transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4,0.0,0.2,1);
    }

    .flashcard.flipped { transform: rotateY(180deg); }

    .flashcard-front, .flashcard-back {
      position: absolute; top: 0; left: 0; width: 100%; min-height: 350px;
      backface-visibility: hidden; border-radius: 20px; padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: flex;
      flex-direction: column; justify-content: center;
    }

    .flashcard-front {
      background: linear-gradient(135deg, #e65100 0%, #ff8f00 100%);
      color: white; text-align: center;
    }

    .flashcard-front h3 { font-size: 1.8em; margin-bottom: 20px; }
    .flashcard-front .flashcard-sanskrit { font-size: 1.05em; font-style: italic; opacity: 0.9; line-height: 1.6; }
    .flashcard-front .flip-hint { font-size: 0.85em; opacity: 0.6; margin-top: 20px; }

    .flashcard-back {
      background: white; transform: rotateY(180deg); text-align: left;
    }

    .fc-section { margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
    .fc-section:last-child { border-bottom: none; }
    .fc-label { font-weight: 600; color: #e65100; display: block; margin-bottom: 4px; font-size: 0.9em; }

    .flashcard-nav { display: flex; justify-content: center; gap: 20px; }

    /* Mode selector */
    .mode-select {
      display: flex; gap: 20px; justify-content: center;
      margin-bottom: 25px; flex-wrap: wrap;
    }

    .mode-btn {
      padding: 20px 30px; border: 2px solid #e0e0e0; border-radius: 15px;
      cursor: pointer; transition: all 0.2s ease; background: white;
      text-align: center; min-width: 160px;
    }

    .mode-btn:hover { border-color: #e65100; }
    .mode-btn.active { border-color: #e65100; background: #fff3e0; }
    .mode-btn .emoji { font-size: 2.2em; margin-bottom: 8px; }
    .mode-btn .text { font-weight: 600; color: #333; font-size: 1.05em; }
    .mode-btn .desc { font-size: 0.8em; color: #888; margin-top: 4px; }

    @media (max-width: 600px) {
      .header h1 { font-size: 1.8em; }
      .question-text { font-size: 1.1em; }
      .option { padding: 14px 18px; font-size: 1em; }
      .score-bar { flex-wrap: wrap; gap: 15px; }
      .matching-container { flex-direction: column; gap: 15px; }
      .mode-select { gap: 10px; }
      .mode-btn { min-width: 140px; padding: 15px 20px; }
      .flashcard-front h3 { font-size: 1.4em; }
      .flashcard { min-height: 300px; }
      .flashcard-front, .flashcard-back { min-height: 300px; padding: 20px; }
      .flashcard-controls { flex-wrap: wrap; gap: 10px; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="level-badge">Level 2</span>
      <h1>Shloka Quiz</h1>
      <p class="subtitle">Test your knowledge of sacred verses</p>
    </div>

    <div id="start-screen" class="question-card start-screen">
      <h2>Welcome to Shloka Quiz - Level 2!</h2>
      <p>These are deeper shlokas with rich meanings. Enter your name and pick a difficulty to begin.</p>

      <div class="name-input" style="margin-bottom: 25px;">
        <input type="text" id="student-name" placeholder="Enter your name"
               style="padding: 15px 20px; font-size: 1.1em; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%; max-width: 300px; text-align: center;">
      </div>

      <div class="mode-select">
        <div class="mode-btn active" id="quiz-mode-btn" data-mode="quiz" onclick="selectMode('quiz', this)">
          <div class="emoji">&#x1F4DD;</div>
          <div class="text">Quiz Mode</div>
          <div class="desc">Test your knowledge</div>
        </div>
        <div class="mode-btn" id="flashcard-mode-btn" data-mode="flashcard" onclick="selectMode('flashcard', this)">
          <div class="emoji">&#x1F4DA;</div>
          <div class="text">Flashcard Mode</div>
          <div class="desc">Study and review</div>
        </div>
      </div>

      <div id="quiz-options">
        <div class="difficulty-label" style="color: white; margin-bottom: 10px; font-weight: 500;">Select Difficulty:</div>
        <select id="difficulty-dropdown" style="padding: 12px 20px; font-size: 1.1em; border: 2px solid #e0e0e0; border-radius: 10px; background: white; margin-bottom: 25px; width: 100%; max-width: 200px;">
          <option value="all">ğŸŒŸ All Levels</option>
          <option value="simple">ğŸŒ± Simple</option>
          <option value="intermediate">ğŸŒ¿ Intermediate</option>
          <option value="difficult">ğŸŒ³ Difficult</option>
        </select>
      </div>

      <button class="btn btn-primary" onclick="startSelected()">Start</button>
    </div>

    <div id="quiz-screen" class="hidden">
      <div class="score-bar">
        <div class="score-item">
          <div class="label">Score</div>
          <div class="value" id="current-score">0</div>
        </div>
        <div class="score-item">
          <div class="label">Question</div>
          <div class="value"><span id="current-question">1</span>/<span id="total-questions">10</span></div>
        </div>
        <div class="score-item">
          <div class="label">Correct</div>
          <div class="value" id="correct-count">0</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>

      <div class="question-card" id="question-card"></div>
    </div>

    <div id="results-screen" class="question-card results hidden">
      <h2>Quiz Complete!</h2>
      <p style="color: #e65100; font-size: 1.1em; margin-bottom: 10px;">Well done, <span id="result-name"></span>!</p>
      <div class="score-circle">
        <div class="percentage" id="final-percentage">0%</div>
        <div class="label">Score</div>
      </div>
      <p class="message" id="result-message"></p>
      <div class="stats">
        <div class="stat">
          <div class="value" id="final-correct">0</div>
          <div class="label">Correct</div>
        </div>
        <div class="stat">
          <div class="value" id="final-wrong">0</div>
          <div class="label">Wrong</div>
        </div>
        <div class="stat">
          <div class="value" id="final-total">0</div>
          <div class="label">Total</div>
        </div>
      </div>
      <p id="score-submitted" class="hidden" style="color: #4caf50; font-size: 0.9em; margin-top: 15px;">Your score has been sent to your teacher!</p>
      <div style="display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: 20px auto;">
        <button class="btn btn-primary" id="submit-score-btn" onclick="submitScoreToGoogleFormManual()" style="margin-top:0;">Submit Score</button>
        <button class="btn btn-secondary" id="study-wrong-btn" onclick="studyWrongAnswers()" style="display: none; margin-top:0;">Review Mistakes</button>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="restartQuiz()" style="flex: 1; margin-top:0;">Try Again</button>
          <button class="btn btn-secondary" onclick="goHome()" style="flex: 1; margin-top:0;">Home</button>
        </div>
      </div>
    </div>

    <div id="flashcard-screen" class="hidden">
      <div class="flashcard-controls">
        <button class="btn btn-secondary" onclick="shuffleFlashcards()" style="margin-top:0; padding: 10px 20px; font-size: 0.9em;">Shuffle</button>
        <span class="flashcard-counter" id="flashcard-counter">1 / 5</span>
        <button class="btn btn-secondary" onclick="goHome()" style="margin-top:0; padding: 10px 20px; font-size: 0.9em;">Home</button>
      </div>

      <div class="flashcard-wrapper" id="flashcard-wrapper">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="flashcard-front">
            <h3 id="fc-name"></h3>
            <p class="flashcard-sanskrit" id="fc-sanskrit"></p>
            <p class="flip-hint">Tap to flip</p>
          </div>
          <div class="flashcard-back">
            <div class="fc-section">
              <span class="fc-label">Meaning:</span>
              <span id="fc-meaning"></span>
            </div>
            <div class="fc-section">
              <span class="fc-label">Deity:</span>
              <span id="fc-deity"></span>
            </div>
            <div class="fc-section">
              <span class="fc-label">Occasion:</span>
              <span id="fc-occasion"></span>
            </div>
            <div class="fc-section">
              <span class="fc-label">Deep Meaning:</span>
              <span id="fc-deep"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="flashcard-nav">
        <button class="btn btn-secondary" onclick="prevCard()" style="margin-top: 0;">Previous</button>
        <button class="btn btn-primary" onclick="nextCard()" style="margin-top: 0;">Next</button>
      </div>
    </div>
  </div>

  <script>
    var allQuestions = [{"question":"Which deity is worshipped in \"Mantra Pushpam\"?","options":["Vedic Universal Prayer","Indra, Pusha, Tarkshya, Brihaspati","Durga","Saraswati"],"answer":"Vedic Universal Prayer","shloka":"Mantra Pushpam","type":"multiple_choice","difficulty":"simple","id":11},{"question":"Which of these keywords is related to \"Saraswati Vandana\"?","options":["weapons","white","stars","flower"],"answer":"white","shloka":"Saraswati Vandana","type":"multiple_choice","difficulty":"simple","id":8},{"question":"How many verses does \"Mahalakshmi Ashtakam\" have?","options":["8","5","10","7"],"answer":"8","shloka":"Mahalakshmi Ashtakam","type":"multiple_choice","difficulty":"simple","id":20},{"type":"matching","question":"Match each shloka with its source scripture:","pairs":[{"left":"Mahalakshmi Ashtakam","right":"Padma Purana (attributed to Indra)"},{"left":"Saraswati Vandana","right":"Unknown"},{"left":"Shanti Mantra (Bhadram Karnebhih)","right":"Rig Veda / Atharva Veda"},{"left":"Mantra Pushpam","right":"Taittiriya Aranyaka (Yajur Veda)"}],"matchType":"name_source","rightLabel":"Source","shloka":"Multiple","difficulty":"intermediate","id":24},{"type":"audio_recite","question":"Recite a shloka about Ganesha","hint":"Ganesha Stavah","correctSanskrit":"ajaM nirvikalpaM nirAkAramEkaM nirAnanda mAnanda madvaitapUrNaM paraM nirguNaM nirvishEShaM nirIhaM parabrahmarUpaM gaNEshaM bhajEma","shloka":"Ganesha Stavah","difficulty":"difficult","id":27},{"question":"\"Saraswati Vandana\" is a prayer for what?","options":["Protection from evil","Seeking knowledge and removal of ignorance","Honoring teachers","Peace and well-being through all senses"],"answer":"Seeking knowledge and removal of ignorance","shloka":"Saraswati Vandana","type":"multiple_choice","difficulty":"simple","id":7},{"type":"audio_recite","question":"Recite a shloka about Saraswati","hint":"Saraswati Vandana","correctSanskrit":"YÄ kundendu tuá¹£hÄra hÄra dhavalÄ yÄ Å›hubhra vastrÄvá¹›tÄ YÄ vÄ«á¹‡Ä vara daá¹‡á¸a maá¹‡á¸ita karÄ yÄ Å›hveta padmÄsanÄ YÄ brahmÄchyuta Å›haá¹…kara prabhá¹›tibhir devaiá¸¥ sadÄ vanditÄ SÄ mÄá¹ pÄtu SarasvatÄ« BhagavatÄ« nisá¸¥Å›heá¹£a jÄá¸yÄpahÄ","shloka":"Saraswati Vandana","difficulty":"difficult","id":28},{"question":"When should we chant \"Mantra Pushpam\"?","options":["Before study / Saraswati Puja / Vasant Panchami","End of puja / Offering of mantras to deity","Lakshmi Puja / Diwali / Friday worship","Before eating"],"answer":"End of puja / Offering of mantras to deity","shloka":"Mantra Pushpam","type":"multiple_choice","difficulty":"simple","id":9},{"question":"True or False: \"Mantra Pushpam\" is chanted during before study / saraswati puja / vasant panchami.","options":["True","False"],"answer":"False","shloka":"Mantra Pushpam","type":"multiple_choice","difficulty":"simple","id":10},{"question":"True or False: \"Mahalakshmi Ashtakam\" is chanted during lakshmi puja / diwali / friday worship.","options":["True","False"],"answer":"True","shloka":"Mahalakshmi Ashtakam","type":"multiple_choice","difficulty":"simple","id":18},{"question":"True or False: \"Ganesha Stavah\" is chanted during ganesha worship / beginning of study.","options":["True","False"],"answer":"True","shloka":"Ganesha Stavah","type":"multiple_choice","difficulty":"simple","id":2},{"type":"matching","question":"Match each shloka with its meaning:","pairs":[{"left":"Ganesha Stavah","right":"Ganesha as the formless Parabrahman"},{"left":"Mahalakshmi Ashtakam","right":"Mahalakshmi gives both worldly joy and liberation"},{"left":"Mantra Pushpam","right":"Everything in nature is connected through water"},{"left":"Saraswati Vandana","right":"Saraswati removes all ignorance and dullness"}],"matchType":"name_meaning","rightLabel":"Meaning","shloka":"Multiple","difficulty":"intermediate","id":21},{"question":"True or False: \"Shanti Mantra (Bhadram Karnebhih)\" is chanted during beginning and end of vedic study / puja.","options":["True","False"],"answer":"True","shloka":"Shanti Mantra (Bhadram Karnebhih)","type":"multiple_choice","difficulty":"simple","id":14},{"question":"Which of these keywords is related to \"Shanti Mantra (Bhadram Karnebhih)\"?","options":["thunder","ears","rivers","fruit"],"answer":"ears","shloka":"Shanti Mantra (Bhadram Karnebhih)","type":"multiple_choice","difficulty":"simple","id":16},{"question":"True or False: \"Saraswati Vandana\" is chanted during before study / saraswati puja / vasant panchami.","options":["True","False"],"answer":"True","shloka":"Saraswati Vandana","type":"multiple_choice","difficulty":"simple","id":6},{"type":"audio_fill","question":"Say the missing part of \"Mantra Pushpam\":","sanskritWithBlank":"yÅ-'pÄ-mpuá¹£paá¹ƒ vÄ“da Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati ________ ya Ä“vaá¹ƒ vÄ“da YÅ-'pÄm Äyatanaá¹ƒ vÄ“da Ä€yatanavÄn bhavati","correctPart":"chandramÄ vÄ apÄmpuá¹£pam","fullSanskrit":"yÅ-'pÄ-mpuá¹£paá¹ƒ vÄ“da Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati chandramÄ vÄ apÄmpuá¹£pam Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati ya Ä“vaá¹ƒ vÄ“da YÅ-'pÄm Äyatanaá¹ƒ vÄ“da Ä€yatanavÄn bhavati","shloka":"Mantra Pushpam","difficulty":"intermediate","id":26},{"type":"matching","question":"Match each shloka with its deity:","pairs":[{"left":"Shanti Mantra (Bhadram Karnebhih)","right":"Indra, Pusha, Tarkshya (Garuda), Brihaspati"},{"left":"Ganesha Stavah","right":"Ganesha"},{"left":"Mahalakshmi Ashtakam","right":"Mahalakshmi"},{"left":"Mantra Pushpam","right":"Vedic Universal Prayer"}],"matchType":"name_deity","rightLabel":"Deity","shloka":"Multiple","difficulty":"intermediate","id":22},{"question":"When should we chant \"Saraswati Vandana\"?","options":["Before bathing","Lighting the lamp","Before study / Saraswati Puja / Vasant Panchami","End of puja / Offering of mantras to deity"],"answer":"Before study / Saraswati Puja / Vasant Panchami","shloka":"Saraswati Vandana","type":"multiple_choice","difficulty":"simple","id":5},{"question":"When should we chant \"Shanti Mantra (Bhadram Karnebhih)\"?","options":["Beginning and end of Vedic study / Puja","Evening prayer","Before study / Saraswati Puja / Vasant Panchami","Lighting the lamp"],"answer":"Beginning and end of Vedic study / Puja","shloka":"Shanti Mantra (Bhadram Karnebhih)","type":"multiple_choice","difficulty":"simple","id":13},{"question":"Which of these keywords is related to \"Mantra Pushpam\"?","options":["peace","birds","money","water"],"answer":"water","shloka":"Mantra Pushpam","type":"multiple_choice","difficulty":"simple","id":12},{"question":"Which deity is worshipped in \"Shanti Mantra (Bhadram Karnebhih)\"?","options":["Brahman (Supreme Reality)","Indra, Pusha, Tarkshya (Garuda), Brihaspati","Rama","Shiva"],"answer":"Indra, Pusha, Tarkshya (Garuda), Brihaspati","shloka":"Shanti Mantra (Bhadram Karnebhih)","type":"multiple_choice","difficulty":"simple","id":15},{"type":"matching","question":"Match each shloka with its occasion:","pairs":[{"left":"Shanti Mantra (Bhadram Karnebhih)","right":"Beginning and end of Vedic study / Puja"},{"left":"Ganesha Stavah","right":"Ganesha worship / Beginning of study"},{"left":"Mahalakshmi Ashtakam","right":"Lakshmi Puja / Diwali / Friday worship"},{"left":"Mantra Pushpam","right":"End of puja / Offering of mantras to deity"}],"matchType":"name_occasion","rightLabel":"Occasion","shloka":"Multiple","difficulty":"intermediate","id":23},{"question":"\"Mahalakshmi Ashtakam\" is a prayer for what?","options":["Worshipping Ganesha as Supreme Reality","Protection from evil","Seeking blessings of wealth and liberation","Offering mantras as flowers to the deity"],"answer":"Seeking blessings of wealth and liberation","shloka":"Mahalakshmi Ashtakam","type":"multiple_choice","difficulty":"simple","id":19},{"question":"\"Ganesha Stavah\" is a prayer for what?","options":["Peace and well-being through all senses","Seeking knowledge and removal of ignorance","Blessing food with gratitude","Worshipping Ganesha as Supreme Reality"],"answer":"Worshipping Ganesha as Supreme Reality","shloka":"Ganesha Stavah","type":"multiple_choice","difficulty":"simple","id":3},{"type":"audio_fill","question":"Say the missing part of \"Ganesha Stavah\":","sanskritWithBlank":"ajaM nirvikalpaM nirAkAramEkaM ________ paraM nirguNaM nirvishEShaM nirIhaM parabrahmarUpaM gaNEshaM bhajEma","correctPart":"nirAnanda mAnanda madvaitapUrNaM","fullSanskrit":"ajaM nirvikalpaM nirAkAramEkaM nirAnanda mAnanda madvaitapUrNaM paraM nirguNaM nirvishEShaM nirIhaM parabrahmarUpaM gaNEshaM bhajEma","shloka":"Ganesha Stavah","difficulty":"intermediate","id":25}];
    var allShlokas = [{"id":1,"name":"Ganesha Stavah","sanskrit":"ajaM nirvikalpaM nirAkAramEkaM nirAnanda mAnanda madvaitapUrNaM paraM nirguNaM nirvishEShaM nirIhaM parabrahmarUpaM gaNEshaM bhajEma","sanskritParts":["ajaM nirvikalpaM nirAkAramEkaM","nirAnanda mAnanda madvaitapUrNaM","paraM nirguNaM nirvishEShaM nirIhaM","parabrahmarUpaM gaNEshaM bhajEma"],"meaning":"Let us worship Ganesha who is the form of Parabrahman â€” unborn, beyond thought, formless, one, beyond joy yet full of non-dual bliss, supreme, beyond qualities, beyond distinction, desireless.","deity":"Ganesha","occasion":"Ganesha worship / Beginning of study","source":"Ganpati Upanishad / Ganesha Stavam by Adi Shankaracharya","keywords":["Parabrahman","unborn","formless","non-dual","beyond qualities","Adi Shankaracharya"],"verses":3,"deepMeaning":{"symbolism":"Ganesha is not just an elephant-headed deity but the Supreme Reality (Parabrahman) itself â€” formless, infinite, and beyond all attributes","keyTerms":{"ajam":"Unborn - He was never born and will never die","nirvikalpam":"Beyond thought/imagination","nirAkAram":"Formless","advaitapUrNam":"Full of non-dual bliss","nirguNam":"Beyond the three gunas (qualities)"},"refrain":"Each verse ends with 'parabrahmarUpaM gaNEshaM bhajEma' - Let us worship Ganesha who is the form of Parabrahman","verse3theme":"Verse 3 describes Ganesha as jagatkAraNam - the cause of the entire universe, worshipped by all gods and the whole world"},"trivia":"This is an Advaita Vedanta hymn â€” it describes Ganesha not in physical form but as the formless Supreme Reality"},{"id":2,"name":"Saraswati Vandana","sanskrit":"YÄ kundendu tuá¹£hÄra hÄra dhavalÄ yÄ Å›hubhra vastrÄvá¹›tÄ YÄ vÄ«á¹‡Ä vara daá¹‡á¸a maá¹‡á¸ita karÄ yÄ Å›hveta padmÄsanÄ YÄ brahmÄchyuta Å›haá¹…kara prabhá¹›tibhir devaiá¸¥ sadÄ vanditÄ SÄ mÄá¹ pÄtu SarasvatÄ« BhagavatÄ« nisá¸¥Å›heá¹£a jÄá¸yÄpahÄ","sanskritParts":["YÄ kundendu tuá¹£hÄra hÄra dhavalÄ yÄ Å›hubhra vastrÄvá¹›tÄ","YÄ vÄ«á¹‡Ä vara daá¹‡á¸a maá¹‡á¸ita karÄ yÄ Å›hveta padmÄsanÄ","YÄ brahmÄchyuta Å›haá¹…kara prabhá¹›tibhir devaiá¸¥ sadÄ vanditÄ","SÄ mÄá¹ pÄtu SarasvatÄ« BhagavatÄ« nisá¸¥Å›heá¹£a jÄá¸yÄpahÄ"],"meaning":"She who is as white as jasmine, moon, snow, and pearl necklace, who wears pure white garments, whose hands are adorned with the veena, who sits on a white lotus, who is always worshipped by Brahma, Vishnu (Achyuta), Shiva (Shankara) and other gods â€” may that Saraswati Bhagavati, the remover of all ignorance and dullness, protect me.","deity":"Saraswati","occasion":"Before study / Saraswati Puja / Vasant Panchami","keywords":["white","jasmine","moon","veena","lotus","Brahma","Vishnu","Shiva","ignorance","dullness"],"deepMeaning":{"symbolism":"Every aspect of Saraswati is white â€” representing purity of knowledge, untainted by worldly desires","appearance":{"color":"White as jasmine (kunda), moon (indu), snow (tushara), and pearl necklace (hara)","clothes":"Pure white garments (shubhra vastra)","hands":"Adorned with the veena (stringed instrument of learning)","seat":"White lotus (shveta padmasana)"},"worshippers":"Even the Trinity â€” Brahma (creator), Achyuta/Vishnu (preserver), and Shankara/Shiva (destroyer) â€” worship her","blessing":"Nishshesha jadyapaha â€” complete remover of all ignorance and mental dullness"},"trivia":"This shloka is recited across India before exams and at the start of educational events"},{"id":3,"name":"Mantra Pushpam","sanskrit":"yÅ-'pÄ-mpuá¹£paá¹ƒ vÄ“da Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati chandramÄ vÄ apÄmpuá¹£pam Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati ya Ä“vaá¹ƒ vÄ“da YÅ-'pÄm Äyatanaá¹ƒ vÄ“da Ä€yatanavÄn bhavati","sanskritParts":["yÅ-'pÄ-mpuá¹£paá¹ƒ vÄ“da","Puá¹£pavÄn prajÄvÄn paÅ›umÄn bhavati","chandramÄ vÄ apÄmpuá¹£pam","ya Ä“vaá¹ƒ vÄ“da","YÅ-'pÄm Äyatanaá¹ƒ vÄ“da","Ä€yatanavÄn bhavati"],"meaning":"He who knows the flower of water becomes endowed with flowers, progeny, and cattle. The moon is the flower of water. He who knows the support (ayatanam) of water becomes established. The hymn then traces water's connection to fire, wind, sun, moon, stars, rain, and the year.","deity":"Vedic Universal Prayer","occasion":"End of puja / Offering of mantras to deity","source":"Taittiriya Aranyaka (Yajur Veda)","keywords":["water","flower","moon","fire","wind","sun","stars","rain","year","ayatanam","Kubera"],"deepMeaning":{"symbolism":"Water is the foundation of all life â€” the hymn traces cosmic connections showing how everything in nature is interconnected through water","connections":{"water_flower":"Moon (Chandrama) is the flower of water","water_fire":"Fire (Agni) is the support of water, and water is the support of fire","water_wind":"Wind (Vayu) is the support of water","water_sun":"The Sun is the support of water","water_moon":"Moon is the support of water","water_stars":"Stars (Nakshatra) are the support of water","water_rain":"Rain (Parjanya) is the support of water","water_year":"The Year (Samvatsara) is the support of water"},"refrain":"Each section ends with 'Ä€yatanavÄn bhavati' â€” one becomes established/supported","conclusion":"Ends with a prayer to the King of Kings (Rajadhiraja) and Kubera"},"trivia":"Mantra Pushpam is chanted at the end of all Vedic pujas while offering flowers â€” the mantras themselves become the flowers offered to God"},{"id":4,"name":"Shanti Mantra (Bhadram Karnebhih)","sanskrit":"Om Bhadram karnebhih Shrnnuyaama Devaah Bhadram Pashye maAkssabhir-Yajatraah Sthirai Ranggai stussttuva(g)um sastanuubhih Vyashema Deva hitam Yad-Aayuh Svasti Na Indro Vruddha-Shravaah Svasti Nah Puushaa Vishva-Vedaah Svasti Nah-staarkshyo Arissta-Nemih Svasti No Brihaspatir-Dadhaatu Om Shaantih Shaantih Shaantih","sanskritParts":["Om Bhadram karnebhih Shrnnuyaama Devaah","Bhadram Pashye maAkssabhir-Yajatraah","Sthirai Ranggai stussttuva(g)um sastanuubhih","Vyashema Deva hitam Yad-Aayuh","Svasti Na Indro Vruddha-Shravaah","Svasti Nah Puushaa Vishva-Vedaah","Svasti Nah-staarkshyo Arissta-Nemih","Svasti No Brihaspatir-Dadhaatu","Om Shaantih Shaantih Shaantih"],"meaning":"O Gods, may we hear auspicious things with our ears. O worshipful ones, may we see auspicious things with our eyes. May we live our full lifespan allotted by the gods with strong limbs and healthy bodies. May Indra of great fame bless us. May Pusha, the all-knowing, bless us. May Tarkshya (Garuda) of unobstructed path bless us. May Brihaspati grant us well-being. Om Peace, Peace, Peace.","deity":"Indra, Pusha, Tarkshya (Garuda), Brihaspati","occasion":"Beginning and end of Vedic study / Puja","source":"Rig Veda / Atharva Veda","keywords":["ears","eyes","limbs","lifespan","Indra","Pusha","Tarkshya","Brihaspati","Svasti","peace"],"deepMeaning":{"symbolism":"Prays for the proper functioning of all senses and a full, healthy life in service of the divine","prayers":{"ears":"Bhadram karnebhih â€” May we hear only good/auspicious things","eyes":"Bhadram pashyema â€” May we see only good/auspicious things","body":"Sthirai angai â€” With firm/strong limbs","life":"Vyashema deva hitam yad-aayuh â€” May we live the full divine lifespan"},"fourDeities":{"Indra":"King of gods, of great fame (Vruddha-Shravah)","Pusha":"Sun god, the all-knowing (Vishva-Vedah)","Tarkshya":"Garuda, of unobstructed path (Arishta-Nemih)","Brihaspati":"Guru of the gods, teacher of wisdom"},"svasti":"Svasti means well-being/blessings â€” asked from four different deities"},"trivia":"This is one of the most widely used shanti mantras, chanted at the beginning and end of Vedic recitations"},{"id":5,"name":"Mahalakshmi Ashtakam","sanskrit":"namastÄ“'stu mahÄmÄyÄ“ Å›rÄ«pÄ«á¹­hÄ“ surapÅ«jitÄ“ Å›aá¹…khachakra gadÄhastÄ“ mahÄlaká¹£mi namÅ'stu tÄ“","sanskritParts":["namastÄ“'stu mahÄmÄyÄ“ Å›rÄ«pÄ«á¹­hÄ“ surapÅ«jitÄ“","Å›aá¹…khachakra gadÄhastÄ“ mahÄlaká¹£mi namÅ'stu tÄ“","namastÄ“ garuá¸ÄrÅ«á¸hÄ“ kÅlÄsura bhayaá¹…kari","sarvapÄpaharÄ“ dÄ“vi mahÄlaká¹£mi namÅ'stu tÄ“","sarvajÃ±Ä“ sarvavaradÄ“ sarva duá¹£á¹­a bhayaá¹…kari","sarvaduá¸¥kha harÄ“ dÄ“vi mahÄlaká¹£mi namÅ'stu tÄ“","siddhi buddhi pradÄ“ dÄ“vi bhukti mukti pradÄyini","mantra mÅ«rtÄ“ sadÄ dÄ“vi mahÄlaká¹£mi namÅ'stu tÄ“","padmÄsana sthitÄ“ dÄ“vi parabrahma svarÅ«piá¹‡i","paramÄ“Å›i jaganmÄtaá¸¥ mahÄlaká¹£mi namÅ'stu tÄ“","Å›vÄ“tÄmbaradharÄ“ dÄ“vi nÄnÄlaá¹…kÄra bhÅ«á¹£itÄ“","jagasthitÄ“ jaganmÄtaá¸¥ mahÄlaká¹£mi namÅ'stu tÄ“"],"meaning":"Salutations to Mahalakshmi â€” the great Mahamaya worshipped by gods, who holds conch, disc and mace; who rides Garuda and terrified the demon Kolasura; the all-knowing, boon-granting, destroyer of evil and sorrow; giver of success, wisdom, worldly enjoyment and liberation; seated on lotus, form of Parabrahman, supreme goddess, mother of the universe; dressed in white, adorned with ornaments, sustainer of the world.","deity":"Mahalakshmi","occasion":"Lakshmi Puja / Diwali / Friday worship","source":"Padma Purana (attributed to Indra)","keywords":["Mahamaya","conch","disc","mace","Garuda","Kolasura","siddhi","buddhi","mukti","lotus","Parabrahman","mother"],"verses":8,"deepMeaning":{"symbolism":"Mahalakshmi is not just the goddess of wealth â€” she is the Supreme Mother, the form of Parabrahman, who gives both worldly enjoyment (bhukti) and spiritual liberation (mukti)","eightVerses":{"verse1":"Mahamaya, worshipped by gods, holding conch, disc, and mace","verse2":"Rides Garuda, terrified demon Kolasura, remover of all sins","verse3":"All-knowing, all-granting, terrifying to evil, remover of all sorrows","verse4":"Giver of success (siddhi) and wisdom (buddhi), worldly joy and liberation","verse5":"Without beginning or end, primordial energy (Adi Shakti), supreme goddess","verse6":"Gross and subtle, fierce power, great remover of sins","verse7":"Seated on lotus, form of Parabrahman, supreme goddess, mother of universe","verse8":"Dressed in white, adorned with ornaments, sustainer and mother of the world"},"phalaShruti":{"once":"Reading once daily destroys great sins (mahapapa vinashanam)","twice":"Reading twice daily gives wealth and grain (dhana dhanya samanvitah)","thrice":"Reading thrice daily destroys great enemies (mahashatru vinashanam)"}},"trivia":"Ashtakam means 'eight verses' â€” this is one of the most popular Lakshmi stotras, attributed to Indra who composed it to please Lakshmi"}];

    // Google Form configuration
    var GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdLc4T_wQJ5NRI7DgK2KyjYtACBUl7cRwn6EUmEzDKOj-5evQ/formResponse';
    var FORM_FIELDS = {"name":"entry.1000000","score":"entry.1000001","total":"entry.449709735","percentage":"entry.425323407"};

    // Quiz visibility configuration
    var QUIZ_ENABLED = false;

    var questions = [];
    var currentQuestionIndex = 0;
    var score = 0;
    var correctCount = 0;
    var selectedDifficulty = 'all';
    var selectedMode = 'quiz';
    var answered = false;
    var studentName = '';
    var wrongShlokaNames = [];

    // Matching state
    var matchingState = { selectedLeft: null, matched: [], pairs: [] };

    // Audio state
    var mediaRecorder = null;
    var audioChunks = [];
    var recordedBlob = null;

    // Flashcard state
    var flashcardShlokas = [];
    var currentCardIndex = 0;

    /* ---- Mode & Difficulty Selection ---- */

    function selectMode(mode, btn) {
      document.querySelectorAll('.mode-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      selectedMode = mode;
      document.getElementById('quiz-options').style.display = mode === 'quiz' ? 'block' : 'none';
    }

    function selectDifficulty(diff, btn) {
      // Keep for compatibility but use dropdown value
      selectedDifficulty = diff;
    }

    function startSelected() {
      if (selectedMode === 'quiz') {
        studentName = document.getElementById('student-name').value.trim();
        if (!studentName) {
          alert('Please enter your name!');
          document.getElementById('student-name').focus();
          return;
        }
      }
      
      const dropdown = document.getElementById('difficulty-dropdown');
      if (dropdown) selectedDifficulty = dropdown.value;

      if (selectedMode === 'quiz') {
        startQuiz();
      } else {
        startFlashcards();
      }
    }

    /* ---- Quiz Mode ---- */

    function filterQuestions() {
      if (selectedDifficulty === 'all') {
        questions = allQuestions.slice();
      } else {
        questions = allQuestions.filter(function(q) { return q.difficulty === selectedDifficulty; });
      }
      questions = questions.sort(function() { return Math.random() - 0.5; });
      questions = questions.slice(0, Math.min(15, questions.length));
    }

    function startQuiz() {
      studentName = document.getElementById('student-name').value.trim();
      if (!studentName) {
        alert('Please enter your name!');
        document.getElementById('student-name').focus();
        return;
      }

      filterQuestions();
      if (questions.length === 0) {
        alert('No questions available for this difficulty. Try another level!');
        return;
      }
      currentQuestionIndex = 0;
      score = 0;
      correctCount = 0;
      answered = false;
      wrongShlokaNames = [];

      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      document.getElementById('results-screen').classList.add('hidden');
      document.getElementById('flashcard-screen').classList.add('hidden');

      document.getElementById('total-questions').textContent = questions.length;
      updateScore();
      showQuestion();
    }

    function showQuestion() {
      var q = questions[currentQuestionIndex];
      answered = false;

      document.getElementById('current-question').textContent = currentQuestionIndex + 1;
      document.getElementById('progress-fill').style.width = ((currentQuestionIndex) / questions.length * 100) + '%';

      if (q.type === 'matching') {
        showMatchingQuestion(q);
        return;
      }
      if (q.type === 'audio_fill' || q.type === 'audio_recite') {
        showAudioQuestion(q);
        return;
      }

      // Standard multiple choice / true-false / fill-blank
      var optionLetters = ['A', 'B', 'C', 'D'];
      var optionsHTML = '';
      q.options.forEach(function(opt, i) {
        optionsHTML += '<div class="option" data-index="' + i + '" onclick="selectOption(this, ' + i + ')">' +
          '<span class="option-letter">' + optionLetters[i] + '</span>' +
          '<span class="option-text">' + opt + '</span></div>';
      });

      var difficultyClass = 'difficulty-' + q.difficulty;
      var difficultyLabel = q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1);

      document.getElementById('question-card').innerHTML =
        '<div class="question-header">' +
          '<span class="question-number">Question ' + (currentQuestionIndex + 1) + '</span>' +
          '<span class="difficulty-badge ' + difficultyClass + '">' + difficultyLabel + '</span>' +
        '</div>' +
        '<p class="question-text">' + q.question + '</p>' +
        '<div class="options">' + optionsHTML + '</div>' +
        '<div id="feedback" class="feedback hidden"></div>' +
        '<button id="next-btn" class="btn btn-primary btn-center hidden" onclick="nextQuestion()">' +
          (currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'See Results') +
        '</button>';
    }

    function selectOption(element, index) {
      if (answered) return;
      answered = true;

      var q = questions[currentQuestionIndex];
      var selectedAnswer = q.options[index];
      var isCorrect = selectedAnswer === q.answer;

      document.querySelectorAll('.option').forEach(function(opt, i) {
        if (q.options[i] === q.answer) {
          opt.classList.add('correct');
          if (!isCorrect) opt.classList.add('show-correct');
        }
      });

      if (isCorrect) {
        element.classList.add('correct');
        score += 10;
        correctCount++;
        showFeedback(true, 'Correct! Great job!');
      } else {
        element.classList.add('incorrect');
        showFeedback(false, 'Incorrect. The answer is: ' + q.answer);
        if (q.shloka && !wrongShlokaNames.includes(q.shloka)) {
          wrongShlokaNames.push(q.shloka);
        }
      }

      updateScore();
      document.getElementById('next-btn').classList.remove('hidden');
    }

    /* ---- Matching Questions ---- */

    function showMatchingQuestion(q) {
      var leftItems = q.pairs.map(function(p, i) { return { text: p.left, index: i }; });
      var rightItems = q.pairs.map(function(p, i) { return { text: p.right, index: i }; });
      leftItems.sort(function() { return Math.random() - 0.5; });
      rightItems.sort(function() { return Math.random() - 0.5; });

      matchingState = { selectedLeft: null, matched: [], pairs: q.pairs };

      var difficultyClass = 'difficulty-' + q.difficulty;
      var difficultyLabel = q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1);

      var leftHTML = leftItems.map(function(item) {
        return '<div class="matching-item matching-left" data-index="' + item.index +
               '" onclick="selectMatchLeft(this, ' + item.index + ')">' + item.text + '</div>';
      }).join('');

      var rightHTML = rightItems.map(function(item) {
        return '<div class="matching-item matching-right" data-index="' + item.index +
               '" onclick="selectMatchRight(this, ' + item.index + ')">' + item.text + '</div>';
      }).join('');

      var rightLabel = q.rightLabel || 'Answer';

      document.getElementById('question-card').innerHTML =
        '<div class="question-header">' +
          '<span class="question-number">Question ' + (currentQuestionIndex + 1) + '</span>' +
          '<span class="difficulty-badge ' + difficultyClass + '">' + difficultyLabel + '</span>' +
        '</div>' +
        '<p class="question-text">' + q.question + '</p>' +
        '<div class="matching-container">' +
          '<div class="matching-column">' +
            '<div class="matching-column-header">Shloka</div>' + leftHTML +
          '</div>' +
          '<div class="matching-column">' +
            '<div class="matching-column-header">' + rightLabel + '</div>' + rightHTML +
          '</div>' +
        '</div>' +
        '<div id="feedback" class="feedback hidden"></div>' +
        '<button class="btn btn-secondary btn-center" onclick="giveUpMatching()" id="giveup-btn">Show Answers</button>' +
        '<button id="next-btn" class="btn btn-primary btn-center hidden" onclick="nextQuestion()">' +
          (currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'See Results') +
        '</button>';
    }

    function selectMatchLeft(el, index) {
      if (answered) return;
      if (matchingState.matched.some(function(m) { return m.left === index; })) return;

      document.querySelectorAll('.matching-left').forEach(function(e) { e.classList.remove('selected'); });
      el.classList.add('selected');
      matchingState.selectedLeft = index;
    }

    function selectMatchRight(el, rightIndex) {
      if (answered) return;
      if (matchingState.selectedLeft === null) return;
      if (matchingState.matched.some(function(m) { return m.right === rightIndex; })) return;

      var leftIndex = matchingState.selectedLeft;

      if (leftIndex === rightIndex) {
        matchingState.matched.push({ left: leftIndex, right: rightIndex });
        document.querySelector('.matching-left[data-index="' + leftIndex + '"]').classList.add('matched');
        document.querySelector('.matching-left[data-index="' + leftIndex + '"]').classList.remove('selected');
        el.classList.add('matched');
        matchingState.selectedLeft = null;

        if (matchingState.matched.length === matchingState.pairs.length) {
          answered = true;
          score += 10;
          correctCount++;
          showFeedback(true, 'All matched correctly! Great job!');
          updateScore();
          document.getElementById('giveup-btn').classList.add('hidden');
          document.getElementById('next-btn').classList.remove('hidden');
        }
      } else {
        el.classList.add('wrong');
        setTimeout(function() { el.classList.remove('wrong'); }, 500);
        document.querySelector('.matching-left[data-index="' + leftIndex + '"]').classList.remove('selected');
        matchingState.selectedLeft = null;
      }
    }

    function giveUpMatching() {
      if (answered) return;
      answered = true;

      matchingState.pairs.forEach(function(pair, i) {
        var leftEl = document.querySelector('.matching-left[data-index="' + i + '"]');
        var rightEl = document.querySelector('.matching-right[data-index="' + i + '"]');
        if (leftEl) leftEl.classList.add('matched');
        if (rightEl) rightEl.classList.add('matched');
      });

      showFeedback(false, 'Here are the correct matches.');
      document.getElementById('giveup-btn').classList.add('hidden');
      document.getElementById('next-btn').classList.remove('hidden');
    }

    /* ---- Audio Questions ---- */

    function showAudioQuestion(q) {
      var difficultyClass = 'difficulty-' + q.difficulty;
      var difficultyLabel = q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1);

      var contentHTML = '';
      var answerText = '';

      if (q.type === 'audio_fill') {
        var displayText = q.sanskritWithBlank.replace('________', '<span class="blank">________</span>');
        contentHTML = '<div class="sanskrit-display">' + displayText + '</div>';
        answerText = '<div class="reveal-label">Missing part:</div><div class="sanskrit">' + q.correctPart + '</div>' +
                     '<div style="margin-top:10px; font-size:0.9em; color:#666;"><strong>Full shloka:</strong> ' + q.fullSanskrit + '</div>';
      } else {
        contentHTML = '<div class="sanskrit-display" style="font-style:normal;">' +
                      '<p style="font-weight:600; font-size:1.1em;">' + q.question + '</p>' +
                      '<p style="margin-top:10px; font-size:0.9em; color:#888;">Hint: ' + q.hint + '</p></div>';
        answerText = '<div class="reveal-label">Expected shloka (' + q.shloka + '):</div>' +
                     '<div class="sanskrit">' + q.correctSanskrit + '</div>';
      }

      document.getElementById('question-card').innerHTML =
        '<div class="question-header">' +
          '<span class="question-number">Question ' + (currentQuestionIndex + 1) + '</span>' +
          '<span class="difficulty-badge ' + difficultyClass + '">' + difficultyLabel + '</span>' +
        '</div>' +
        '<p class="question-text">' + q.question + '</p>' +
        '<div class="audio-container">' +
          contentHTML +
          '<div class="audio-controls">' +
            '<button class="record-btn" id="record-btn" onclick="toggleRecording()">&#9679;</button>' +
            '<button class="playback-btn" id="playback-btn" onclick="playRecording()" style="display:none;">&#9654;</button>' +
          '</div>' +
          '<div class="audio-status" id="audio-status">Tap the red button to start recording</div>' +
          '<div id="answer-reveal" class="correct-answer-reveal" style="display:none;">' + answerText + '</div>' +
          '<div id="self-assess" class="self-assess" style="display:none;">' +
            '<button class="self-assess-btn correct-btn" onclick="selfAssess(true)">I got it right</button>' +
            '<button class="self-assess-btn incorrect-btn" onclick="selfAssess(false)">I need more practice</button>' +
          '</div>' +
          '<button class="btn btn-secondary btn-center" id="skip-audio-btn" onclick="skipAudioQuestion()" style="font-size:0.9em; padding:10px 25px;">Skip (show answer)</button>' +
        '</div>' +
        '<div id="feedback" class="feedback hidden"></div>' +
        '<button id="next-btn" class="btn btn-primary btn-center hidden" onclick="nextQuestion()">' +
          (currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'See Results') +
        '</button>';
    }

    function toggleRecording() {
      var btn = document.getElementById('record-btn');
      var status = document.getElementById('audio-status');

      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        btn.classList.remove('recording');
        btn.innerHTML = '&#9679;';
        status.textContent = 'Recording stopped. Tap play to listen.';
        return;
      }

      audioChunks = [];
      recordedBlob = null;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        status.textContent = 'Recording not supported in this browser. Use Skip to see the answer.';
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(function(stream) {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = function(e) { audioChunks.push(e.data); };
          mediaRecorder.onstop = function() {
            recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
            stream.getTracks().forEach(function(t) { t.stop(); });
            document.getElementById('playback-btn').style.display = 'inline-block';
            document.getElementById('answer-reveal').style.display = 'block';
            document.getElementById('self-assess').style.display = 'flex';
            document.getElementById('skip-audio-btn').style.display = 'none';
          };
          mediaRecorder.start();
          btn.classList.add('recording');
          btn.innerHTML = '&#9632;';
          status.textContent = 'Recording... Tap to stop.';
        })
        .catch(function() {
          status.textContent = 'Microphone not available. Use Skip to see the answer.';
        });
    }

    function playRecording() {
      if (!recordedBlob) return;
      var audio = new Audio(URL.createObjectURL(recordedBlob));
      audio.play();
      document.getElementById('audio-status').textContent = 'Playing your recording...';
      audio.onended = function() {
        document.getElementById('audio-status').textContent = 'Compare your recording with the answer below.';
      };
    }

    function selfAssess(isCorrect) {
      if (answered) return;
      answered = true;

      if (isCorrect) {
        score += 10;
        correctCount++;
        showFeedback(true, 'Great! Keep practicing!');
      } else {
        showFeedback(false, 'Keep practicing - you will get it next time!');
        var q = questions[currentQuestionIndex];
        if (q.shloka && !wrongShlokaNames.includes(q.shloka)) {
          wrongShlokaNames.push(q.shloka);
        }
      }

      document.querySelectorAll('.self-assess-btn').forEach(function(b) {
        b.style.opacity = '0.5';
        b.style.pointerEvents = 'none';
      });

      updateScore();
      document.getElementById('next-btn').classList.remove('hidden');
    }

    function skipAudioQuestion() {
      document.getElementById('answer-reveal').style.display = 'block';
      document.getElementById('self-assess').style.display = 'flex';
      document.getElementById('skip-audio-btn').style.display = 'none';
    }

    /* ---- Common Functions ---- */

    function showFeedback(isCorrect, message) {
      var feedback = document.getElementById('feedback');
      feedback.textContent = message;
      feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
      feedback.classList.remove('hidden');
    }

    function updateScore() {
      document.getElementById('current-score').textContent = score;
      document.getElementById('correct-count').textContent = correctCount;
    }

    function nextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        showQuestion();
      } else {
        showResults();
      }
    }

    function showResults() {
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('results-screen').classList.remove('hidden');

      var percentage = Math.round((correctCount / questions.length) * 100);
      document.getElementById('final-percentage').textContent = percentage + '%';
      document.getElementById('final-correct').textContent = correctCount;
      document.getElementById('final-wrong').textContent = questions.length - correctCount;
      document.getElementById('final-total').textContent = questions.length;

      var message = '';
      if (percentage >= 90) message = 'Outstanding! You are a Shloka master!';
      else if (percentage >= 70) message = 'Great job! Keep practicing!';
      else if (percentage >= 50) message = 'Good effort! Review the shlokas and try again!';
      else message = 'Keep learning! Practice makes perfect!';

      document.getElementById('result-message').textContent = message;
      document.getElementById('result-name').textContent = studentName;

      // Show study wrong button if there are mistakes
      const studyBtn = document.getElementById('study-wrong-btn');
      if (studyBtn && wrongShlokaNames.length > 0) {
        studyBtn.style.display = 'block';
      } else if (studyBtn) {
        studyBtn.style.display = 'none';
      }
      
      // Reset submit button
      const submitBtn = document.getElementById('submit-score-btn');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.textContent = 'Submit Score';
      }
      document.getElementById('score-submitted').classList.add('hidden');
    }

    function submitScoreToGoogleFormManual() {
      const percentage = Math.round((correctCount / questions.length) * 100);
      submitScoreToGoogleForm(percentage);
      
      const submitBtn = document.getElementById('submit-score-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.textContent = 'Submitted';
      }
    }

    function submitScoreToGoogleForm(percentage) {
      if (!GOOGLE_FORM_URL) return;

      var formData = new URLSearchParams();
      formData.append(FORM_FIELDS.name, studentName);
      formData.append(FORM_FIELDS.score, correctCount.toString());
      formData.append(FORM_FIELDS.total, questions.length.toString());
      formData.append(FORM_FIELDS.percentage, percentage.toString());
      if (FORM_FIELDS.difficulty) formData.append(FORM_FIELDS.difficulty, selectedDifficulty);

      fetch(GOOGLE_FORM_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData.toString()
      }).then(function() {
        document.getElementById('score-submitted').classList.remove('hidden');
      }).catch(function() {});
    }

    function restartQuiz() {
      filterQuestions();
      currentQuestionIndex = 0;
      score = 0;
      correctCount = 0;

      document.getElementById('results-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');

      updateScore();
      showQuestion();
    }

    function goHome() {
      document.getElementById('results-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('flashcard-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
    }

    /* ---- Flashcard Mode ---- */

    function startFlashcards() {
      flashcardShlokas = allShlokas.slice();
      currentCardIndex = 0;
      
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('flashcard-screen').classList.remove('hidden');
      document.getElementById('results-screen').classList.add('hidden');
      
      updateFlashcard();
    }

    function updateFlashcard() {
      const s = flashcardShlokas[currentCardIndex];
      const card = document.getElementById('flashcard');
      card.classList.remove('flipped');
      
      document.getElementById('fc-name').textContent = s.name;
      document.getElementById('fc-sanskrit').textContent = s.sanskrit || '';
      document.getElementById('fc-meaning').textContent = s.meaning || '';
      document.getElementById('fc-deity').textContent = s.deity || '';
      document.getElementById('fc-occasion').textContent = s.occasion || '';
      document.getElementById('fc-deep').textContent = s.deepMeaning ? s.deepMeaning.summary : '';
      
      document.getElementById('flashcard-counter').textContent = (currentCardIndex + 1) + ' / ' + flashcardShlokas.length;
    }

    function flipCard() {
      document.getElementById('flashcard').classList.toggle('flipped');
    }

    function nextCard() {
      currentCardIndex = (currentCardIndex + 1) % flashcardShlokas.length;
      updateFlashcard();
    }

    function prevCard() {
      currentCardIndex = (currentCardIndex - 1 + flashcardShlokas.length) % flashcardShlokas.length;
      updateFlashcard();
    }

    function shuffleFlashcards() {
      flashcardShlokas.sort(() => Math.random() - 0.5);
      currentCardIndex = 0;
      updateFlashcard();
    }

    function studyWrongAnswers() {
      if (wrongShlokaNames.length === 0) return;
      
      flashcardShlokas = allShlokas.filter(s => wrongShlokaNames.includes(s.name));
      currentCardIndex = 0;
      
      document.getElementById('results-screen').classList.add('hidden');
      document.getElementById('flashcard-screen').classList.remove('hidden');
      
      updateFlashcard();
    }
    /* ---- Initialization ---- */
    window.addEventListener('DOMContentLoaded', function() {
      var urlParams = new URLSearchParams(window.location.search);
      var quizOverride = urlParams.get('quiz') === '1' || urlParams.get('admin') === '1';
      
      if (!QUIZ_ENABLED && !quizOverride) {
        // Hide quiz button and select flashcard mode
        var quizBtn = document.getElementById('quiz-mode-btn');
        var flashBtn = document.getElementById('flashcard-mode-btn');
        var nameInput = document.querySelector('.name-input');
        if (quizBtn) quizBtn.style.display = 'none';
        if (nameInput) nameInput.style.display = 'none';
        if (flashBtn) selectMode('flashcard', flashBtn);
      }
    });
  </script>
</body>
</html>